<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111827" />
  <title>Claude Session Viewer</title>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />

  <!-- é˜² FOUCï¼šåœ¨ä»»ä½• CSS åŠ è½½å‰æ ¹æ® localStorage / ç³»ç»Ÿåå¥½è®¾ç½®ä¸»é¢˜ -->
  <script>
    (function() {
      const stored = localStorage.getItem('theme')
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
      document.documentElement.setAttribute('data-theme', stored || (prefersDark ? 'dark' : 'light'))
    })()
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link id="hljs-theme" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css" />
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>

  <style>
    /* â”€â”€ CSS å˜é‡ï¼šä¸»é¢˜é¢œè‰² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      color-scheme: dark;
      /* Dark themeï¼ˆé»˜è®¤ï¼‰ */
      --bg-primary:      #030712;
      --bg-secondary:    #111827;
      --bg-tertiary:     #1f2937;
      --bg-elevated:     rgba(17, 24, 39, 0.5);

      --border-primary:  #1f2937;
      --border-secondary:#374151;
      --border-subtle:   rgba(55, 65, 81, 0.5);
      --border-faint:    rgba(55, 65, 81, 0.3);

      --text-primary:    #e5e7eb;
      --text-secondary:  #9ca3af;
      --text-muted:      #6b7280;
      --text-faint:      #4b5563;
      --text-fainter:    #374151;
      --text-accent:     #60a5fa;

      --msg-user-bg:     #1e293b;
      --msg-assistant-bg:#111827;

      --code-bg:         #0d1117;
      --code-inline-bg:  #1e293b;
      --code-inline-text:#e2e8f0;

      --tool-bg:         #0f172a;
      --tool-border:     #1e3a5f;
      --thinking-bg:     #1a1a2e;
      --thinking-border: #2d2d4e;

      --scrollbar-thumb: #374151;
      --highlight-bg:    #854d0e;
      --highlight-text:  #fef3c7;

      --hover-bg:            #1e293b;
      --active-project-bg:   #1d4ed8;
      --active-session-bg:   #1e40af;

      --table-header-bg: #1f2937;
      --table-border:    #374151;
      --blockquote-border:#4b5563;
      --blockquote-text: #9ca3af;

      --input-bg:        #1f2937;
      --input-border:    #374151;
      --input-text:      #e5e7eb;
      --input-placeholder:#6b7280;
    }

    [data-theme="light"] {
      color-scheme: light;
      --bg-primary:      #ffffff;
      --bg-secondary:    #f9fafb;
      --bg-tertiary:     #f3f4f6;
      --bg-elevated:     rgba(243, 244, 246, 0.85);

      --border-primary:  #e5e7eb;
      --border-secondary:#d1d5db;
      --border-subtle:   rgba(209, 213, 219, 0.7);
      --border-faint:    rgba(209, 213, 219, 0.5);

      --text-primary:    #111827;
      --text-secondary:  #4b5563;
      --text-muted:      #6b7280;
      --text-faint:      #9ca3af;
      --text-fainter:    #9ca3af;
      --text-accent:     #2563eb;

      --msg-user-bg:     #eff6ff;
      --msg-assistant-bg:#f9fafb;

      --code-bg:         #f6f8fa;
      --code-inline-bg:  #f1f5f9;
      --code-inline-text:#334155;

      --tool-bg:         #eff6ff;
      --tool-border:     #bfdbfe;
      --thinking-bg:     #faf5ff;
      --thinking-border: #e9d5ff;

      --scrollbar-thumb: #d1d5db;
      --highlight-bg:    #fef3c7;
      --highlight-text:  #92400e;

      --hover-bg:            #f3f4f6;
      --active-project-bg:   #2563eb;
      --active-session-bg:   #3b82f6;

      --table-header-bg: #f3f4f6;
      --table-border:    #e5e7eb;
      --blockquote-border:#d1d5db;
      --blockquote-text: #6b7280;

      --input-bg:        #ffffff;
      --input-border:    #d1d5db;
      --input-text:      #111827;
      --input-placeholder:#9ca3af;
    }

    /* â”€â”€ å…¨å±€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    /* â”€â”€ ç»“æ„ç»„ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .top-bar         { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-primary); }
    .sidebar-panel   { background-color: var(--bg-primary);   border-right:  1px solid var(--border-primary); }
    .panel-header    { color: var(--text-muted);               border-bottom: 1px solid var(--border-primary); }
    .chat-panel      { background-color: var(--bg-primary); }
    .chat-panel-header { border-bottom: 1px solid var(--border-primary); }

    /* â”€â”€ è¾“å…¥æ¡† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-field { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--input-text); }
    .input-field::placeholder { color: var(--input-placeholder); }

    /* â”€â”€ ä¸»é¢˜åˆ‡æ¢æŒ‰é’® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .theme-toggle-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid var(--border-secondary);
      background-color: var(--bg-tertiary);
      color: var(--text-muted);
      cursor: pointer;
      transition: background-color 0.15s, color 0.15s, border-color 0.15s;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .theme-toggle-btn:hover { background-color: var(--hover-bg); color: var(--text-primary); }

    /* â”€â”€ æ¸…é™¤æŒ‰é’® hover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #clear-search-btn { color: var(--text-muted); transition: color 0.15s; }
    #clear-search-btn:hover { color: var(--text-primary); }

    /* â”€â”€ ä¸»é¢˜æ–‡å­—è¾…åŠ©ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .t-text-primary   { color: var(--text-primary); }
    .t-text-secondary { color: var(--text-secondary); }
    .t-text-muted     { color: var(--text-muted); }
    .t-text-faint     { color: var(--text-faint); }
    .t-text-fainter   { color: var(--text-fainter); }
    .t-bg-elevated    { background-color: var(--bg-elevated); }
    .t-border-subtle  { border-color: var(--border-subtle); }
    .t-border-faint   { border-color: var(--border-faint); }

    /* â”€â”€ Prose æ ·å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .prose { max-width: none; }
    .prose pre { background: var(--code-bg); border-radius: 6px; padding: 1rem; overflow-x: auto; }
    .prose code:not(pre code) { background: var(--code-inline-bg); color: var(--code-inline-text); padding: 2px 5px; border-radius: 3px; font-size: 0.85em; }
    .prose p { margin: 0.6rem 0; line-height: 1.8; font-size: 0.9375rem; }
    .prose ul, .prose ol { padding-left: 1.5rem; margin: 0.5rem 0; }
    .prose li { margin: 0.25rem 0; }
    .prose h1,.prose h2,.prose h3 { font-weight: 600; margin: 1rem 0 0.5rem; }
    .prose h1 { font-size: 1.4em; }
    .prose h2 { font-size: 1.2em; }
    .prose h3 { font-size: 1.1em; }
    .prose blockquote { border-left: 3px solid var(--blockquote-border); padding-left: 1rem; color: var(--blockquote-text); margin: 0.5rem 0; }
    .prose table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; }
    .prose th, .prose td { border: 1px solid var(--table-border); padding: 0.4rem 0.7rem; }
    .prose th { background: var(--table-header-bg); }
    .prose a { color: var(--text-accent); text-decoration: underline; }

    /* â”€â”€ æ»šåŠ¨æ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .scrollbar-thin::-webkit-scrollbar { width: 4px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 2px; }

    /* â”€â”€ æ¶ˆæ¯ / å·¥å…·å— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tool-block     { background: var(--tool-bg);     border: 1px solid var(--tool-border);     border-radius: 6px; border-left: 3px solid #3b82f6; }
    .tool-block.result { border-left-color: #22c55e; }
    .system-block   { background: var(--tool-bg);     border: 1px solid var(--tool-border);     border-radius: 6px; border-left: 3px solid #6b7280; }
    .thinking-block { background: var(--thinking-bg); border: 1px solid var(--thinking-border); border-radius: 6px; border-left: 3px solid #a855f7; }
    /* å¯æŠ˜å å— chevron åŠ¨ç”» */
    .collapse-chevron { transition: transform 0.18s ease; flex-shrink: 0; }
    .collapse-chevron.open { transform: rotate(90deg); }
    .msg-user      { background: var(--msg-user-bg);      border-left: 3px solid rgba(59,130,246,0.55); }
    .msg-assistant { background: var(--msg-assistant-bg); border-left: 3px solid rgba(34,197,94,0.35); }

    /* â”€â”€ åˆ—è¡¨é¡¹çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .session-card:hover  { background: var(--hover-bg); }
    .project-item:hover  { background: var(--hover-bg); }

    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .delete-session-btn {
      opacity: 0;
      transition: opacity 0.15s;
    }
    .session-card:hover .delete-session-btn {
      opacity: 1;
    }
    .delete-session-btn:hover {
      background-color: rgba(239, 68, 68, 0.1);
      border-radius: 4px;
    }

    /* â”€â”€ å›æ”¶ç«™å¼¹çª— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trash-modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
    .trash-item {
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      transition: border-color 0.15s;
    }
    .trash-item:hover {
      border-color: var(--border-secondary);
    }
    .trash-actions button {
      transition: background-color 0.15s, color 0.15s;
    }
    .trash-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      background-color: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .project-item.active { background: var(--active-project-bg); color: #fff; }
    .session-card.active { background: var(--active-session-bg); color: #fff; }
    /* é€‰ä¸­çŠ¶æ€ä¸‹è¦†ç›–å†…éƒ¨ muted æ–‡å­—ä¸ºåŠé€æ˜ç™½ */
    .project-item.active .t-text-muted,
    .project-item.active .t-text-faint,
    .project-item.active .t-text-secondary,
    .project-item.active .t-text-fainter { color: rgba(255,255,255,0.68); }
    .session-card.active .t-text-muted,
    .session-card.active .t-text-faint,
    .session-card.active .t-text-secondary,
    .session-card.active .t-text-fainter { color: rgba(255,255,255,0.68); }

    /* â”€â”€ å…¶ä»– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #search-input:focus { outline: 2px solid #3b82f6; }
    .highlight-match { background: var(--highlight-bg); color: var(--highlight-text); padding: 0 2px; border-radius: 2px; }

    /* â”€â”€ Focus å¯è§æ€§ï¼ˆé”®ç›˜å¯¼èˆªï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    button:focus-visible,
    [role="button"]:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    /* â”€â”€ è¿åŠ¨æ•æ„Ÿç”¨æˆ·ï¼šå‡å°‘åŠ¨ç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

  <!-- Top Bar -->
  <div class="top-bar px-4 py-2 flex items-center gap-3 flex-shrink-0">
    <div class="text-blue-400 font-bold text-sm tracking-wide">âš¡ Claude Session Viewer</div>
    <div class="flex-1 flex items-center gap-2">
      <input
        id="search-input"
        type="text"
        name="search"
        placeholder="æœç´¢å¯¹è¯å†…å®¹â€¦"
        aria-label="æœç´¢å¯¹è¯å†…å®¹"
        autocomplete="off"
        class="input-field flex-1 max-w-md rounded px-3 py-1.5 text-sm"
      />
      <select id="search-project" aria-label="ç­›é€‰é¡¹ç›®" class="input-field rounded px-2 py-1.5 text-sm">
        <option value="">æ‰€æœ‰é¡¹ç›®</option>
      </select>
      <input type="date" id="search-from" name="search-from" aria-label="å¼€å§‹æ—¥æœŸ" autocomplete="off" class="input-field rounded px-2 py-1.5 text-sm" />
      <span class="t-text-muted text-xs">è‡³</span>
      <input type="date" id="search-to" name="search-to" aria-label="ç»“æŸæ—¥æœŸ" autocomplete="off" class="input-field rounded px-2 py-1.5 text-sm" />
      <button id="search-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded transition">æœç´¢</button>
      <button id="clear-search-btn" class="text-sm px-2 py-1.5 hidden">âœ• æ¸…é™¤</button>
    </div>
    <button id="trash-btn" class="theme-toggle-btn relative" title="å›æ”¶ç«™" aria-label="å›æ”¶ç«™">
      <span aria-hidden="true">ğŸ—‘ï¸</span>
      <span id="trash-badge" class="trash-badge hidden"></span>
    </button>
    <button id="theme-toggle" class="theme-toggle-btn" title="åˆ‡æ¢æ˜æš—æ¨¡å¼" aria-label="åˆ‡æ¢æ˜æš—æ¨¡å¼">
      <span id="theme-icon" aria-hidden="true">ğŸŒ™</span>
    </button>
    <div id="status-indicator" class="text-xs t-text-muted"></div>
  </div>

  <!-- Main Content -->
  <div class="flex flex-1 overflow-hidden">

    <!-- Left: Project List -->
    <div class="sidebar-panel w-56 flex flex-col flex-shrink-0">
      <div class="panel-header px-3 py-2 text-xs font-semibold uppercase tracking-wider">
        é¡¹ç›® <span id="project-count"></span>
      </div>
      <div id="project-list" class="flex-1 overflow-y-auto scrollbar-thin">
        <div class="px-3 py-4 text-sm t-text-muted">åŠ è½½ä¸­â€¦</div>
      </div>
    </div>

    <!-- Middle: Session List -->
    <div class="sidebar-panel w-72 flex flex-col flex-shrink-0">
      <div class="panel-header px-3 py-2 text-xs font-semibold uppercase tracking-wider flex items-center justify-between">
        <span>Sessions <span id="session-count"></span></span>
      </div>
      <div id="session-list" class="flex-1 overflow-y-auto scrollbar-thin">
        <div class="px-3 py-4 text-sm t-text-muted">â† é€‰æ‹©é¡¹ç›®</div>
      </div>
    </div>

    <!-- Right: Chat Detail -->
    <div class="chat-panel flex-1 flex flex-col min-w-0">
      <div id="chat-header" class="chat-panel-header px-4 py-2 flex items-center justify-between flex-shrink-0">
        <div class="text-sm t-text-muted">â† é€‰æ‹© Session</div>
      </div>
      <div id="chat-content" class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-5">
      </div>
    </div>

  </div>

  <!-- å›æ”¶ç«™å¼¹çª— -->
  <div id="trash-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center trash-modal-overlay">
    <div class="bg-[var(--bg-secondary)] rounded-lg shadow-xl w-[600px] max-h-[80vh] flex flex-col border border-[var(--border-primary)]">
      <!-- æ ‡é¢˜æ  -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-[var(--border-primary)]">
        <div class="flex items-center gap-2">
          <span class="text-lg">ğŸ—‘ï¸</span>
          <span class="font-semibold t-text-primary">å›æ”¶ç«™</span>
        </div>
        <button id="close-trash-btn" class="t-text-muted hover:t-text-primary transition-colors" aria-label="å…³é—­å›æ”¶ç«™">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="px-4 py-2 text-sm t-text-muted border-b border-[var(--border-primary)]">
        å…± <span id="trash-count">0</span> ä¸ª session Â· 30 å¤©åè‡ªåŠ¨æ¸…ç†
      </div>

      <!-- åˆ—è¡¨ -->
      <div id="trash-list" class="flex-1 overflow-y-auto p-4 space-y-2" style="max-height: 50vh;">
        <div class="text-center t-text-muted py-8">åŠ è½½ä¸­â€¦</div>
      </div>

      <!-- åº•éƒ¨æ“ä½œ -->
      <div class="px-4 py-3 border-t border-[var(--border-primary)] flex justify-between">
        <button id="close-trash-btn-2" class="px-4 py-2 text-sm t-text-secondary hover:t-text-primary transition-colors">
          å…³é—­
        </button>
        <button id="empty-trash-btn" class="px-4 py-2 text-sm text-red-400 hover:text-red-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          æ¸…ç©ºå›æ”¶ç«™
        </button>
      </div>
    </div>
  </div>

  <script>
  // â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getTheme() {
    return document.documentElement.getAttribute('data-theme') || 'dark'
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme)
    localStorage.setItem('theme', theme)
    const icon = document.getElementById('theme-icon')
    if (icon) icon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸'
    const link = document.getElementById('hljs-theme')
    if (link) {
      link.href = theme === 'dark'
        ? 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css'
        : 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css'
    }
  }

  function toggleTheme() {
    applyTheme(getTheme() === 'dark' ? 'light' : 'dark')
  }

  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const state = {
    projects: [],
    currentProjectId: null,
    currentSessionId: null,
    searchMode: false,
    trashItems: [],
    trashLoading: false
  }

  // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $ = id => document.getElementById(id)
  const setStatus = (msg, isError = false) => {
    const el = $('status-indicator')
    el.textContent = msg
    el.className = `text-xs ${isError ? 'text-red-400' : 't-text-muted'}`
  }

  function timeAgo(isoStr) {
    if (!isoStr) return ''
    const diff = Date.now() - new Date(isoStr).getTime()
    const mins = Math.floor(diff / 60000)
    const hrs = Math.floor(mins / 60)
    const days = Math.floor(hrs / 24)
    if (days > 30) return new Date(isoStr).toLocaleDateString('zh-CN')
    if (days > 0) return `${days}å¤©å‰`
    if (hrs > 0) return `${hrs}å°æ—¶å‰`
    if (mins > 0) return `${mins}åˆ†é’Ÿå‰`
    return 'åˆšåˆš'
  }

  function formatDateTime(isoStr) {
    if (!isoStr) return ''
    return new Date(isoStr).toLocaleString('zh-CN', {
      month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    })
  }

  function shortProjectName(displayName) {
    if (!displayName) return 'æœªçŸ¥'
    const parts = displayName.replace(/\\/g, '/').split('/').filter(Boolean)
    return parts.slice(-2).join('/')
  }

  function groupSessionsByDate(sessions) {
    const now = new Date()
    const today = now.toDateString()
    const yesterday = new Date(now - 86400000).toDateString()
    const weekAgo = new Date(now - 7 * 86400000)

    const groups = { 'ä»Šå¤©': [], 'æ˜¨å¤©': [], 'æœ¬å‘¨': [], 'æ›´æ—©': [] }
    for (const s of sessions) {
      const d = new Date(s.startTime)
      const ds = d.toDateString()
      if (ds === today) groups['ä»Šå¤©'].push(s)
      else if (ds === yesterday) groups['æ˜¨å¤©'].push(s)
      else if (d > weekAgo) groups['æœ¬å‘¨'].push(s)
      else groups['æ›´æ—©'].push(s)
    }
    return groups
  }

  // â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function api(url) {
    const res = await fetch(url)
    const json = await res.json()
    if (!json.success) throw new Error(json.error || 'è¯·æ±‚å¤±è´¥')
    return json.data
  }

  // â”€â”€â”€ Render: Project List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderProjects(projects) {
    const el = $('project-list')
    $('project-count').textContent = `(${projects.length})`

    const sel = $('search-project')
    sel.innerHTML = '<option value="">æ‰€æœ‰é¡¹ç›®</option>'
    projects.forEach(p => {
      const opt = document.createElement('option')
      opt.value = p.id
      opt.textContent = shortProjectName(p.displayName)
      sel.appendChild(opt)
    })

    if (projects.length === 0) {
      el.innerHTML = '<div class="px-3 py-4 text-sm t-text-muted">æ— é¡¹ç›®</div>'
      return
    }

    el.innerHTML = projects.map(p => `
      <div
        class="project-item px-3 py-2.5 cursor-pointer border-b t-border-subtle transition-colors"
        data-id="${p.id}"
        title="${p.displayName}"
        role="button"
        tabindex="0"
        aria-label="${escapeHtml(p.displayName)}"
      >
        <div class="text-sm font-medium t-text-primary truncate">${shortProjectName(p.displayName)}</div>
        <div class="text-xs t-text-muted mt-0.5 flex justify-between">
          <span>${p.sessionCount} sessions</span>
          <span>${timeAgo(p.lastActivity)}</span>
        </div>
      </div>
    `).join('')

    el.querySelectorAll('.project-item').forEach(item => {
      const activate = () => {
        state.searchMode = false
        $('clear-search-btn').classList.add('hidden')
        el.querySelectorAll('.project-item').forEach(i => i.classList.remove('active'))
        item.classList.add('active')
        loadSessions(item.dataset.id)
      }
      item.addEventListener('click', activate)
      item.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate() } })
    })
  }

  // â”€â”€â”€ Render: Session List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSessions(sessions, projectId) {
    const el = $('session-list')
    state.currentProjectId = projectId
    $('session-count').textContent = `(${sessions.length})`

    if (sessions.length === 0) {
      el.innerHTML = '<div class="px-3 py-4 text-sm t-text-muted">æ—  session</div>'
      return
    }

    const groups = groupSessionsByDate(sessions)
    let html = ''
    for (const [label, items] of Object.entries(groups)) {
      if (items.length === 0) continue
      html += `<div class="px-3 py-1.5 text-xs font-semibold t-text-muted uppercase tracking-wider t-bg-elevated sticky top-0">${label}</div>`
      html += items.map(s => `
        <div
          class="session-card px-3 py-3 cursor-pointer border-b t-border-faint transition-colors group relative"
          data-id="${s.id}"
          data-project="${s.projectId || projectId}"
          role="button"
          tabindex="0"
          aria-label="${escapeHtml(s.firstUserMessage || 'ç©º session')}"
        >
          <div class="flex items-start justify-between">
            <div class="text-sm t-text-secondary mb-1 truncate flex-1 pr-6">${s.firstUserMessage || '(ç©º session)'}</div>
            <button
              class="delete-session-btn absolute right-2 top-2 text-red-400 hover:text-red-300 transition-opacity p-1"
              data-id="${s.id}"
              data-project="${s.projectId || projectId}"
              title="åˆ é™¤ session"
              aria-label="åˆ é™¤ session"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
          <div class="text-xs t-text-faint flex items-center gap-2 mt-1">
            <span>${formatDateTime(s.startTime)}</span>
            <span class="t-text-fainter">Â·</span>
            <span>${s.messageCount} æ¡</span>
            ${s.gitBranch ? `<span class="t-text-fainter">Â·</span><span class="text-blue-500">${s.gitBranch}</span>` : ''}
            ${s.hasAssistant ? '' : '<span class="text-yellow-600">ä»…ç”¨æˆ·</span>'}
          </div>
        </div>
      `).join('')
    }
    el.innerHTML = html

    el.querySelectorAll('.session-card').forEach(card => {
      const activate = () => {
        el.querySelectorAll('.session-card').forEach(c => c.classList.remove('active'))
        card.classList.add('active')
        loadSession(card.dataset.project, card.dataset.id)
      }
      card.addEventListener('click', activate)
      card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate() } })
    })

    // åˆ é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬
    el.querySelectorAll('.delete-session-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation() // é˜»æ­¢è§¦å‘ session é€‰æ‹©
        const sessionId = btn.dataset.id
        const projectId = btn.dataset.project
        handleDeleteSession(sessionId, projectId)
      })
    })
  }

  // â”€â”€â”€ Render: Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderContentBlock(block) {
    if (block.type === 'text') {
      const text = block.text || ''
      if (!text.trim()) return ''
      if (text.startsWith('<local-command-') || text.startsWith('<command-') || text.startsWith('<system-reminder>')) {
        const id = 'sys-' + Math.random().toString(36).slice(2)
        return `
          <div class="system-block">
            <button onclick="toggleCollapse('${id}')" class="w-full flex items-center gap-2 px-3 py-2 text-xs t-text-muted hover:t-text-secondary text-left">
              <span>âš™ï¸ ç³»ç»Ÿæ¶ˆæ¯</span>
              <span class="flex-1"></span>
              <svg id="${id}-chevron" class="collapse-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </button>
            <div id="${id}" class="hidden px-3 pb-2">
              <div class="text-xs t-text-faint italic whitespace-pre-wrap">${escapeHtml(text.slice(0, 2000))}${text.length > 2000 ? '\nâ€¦(å·²æˆªæ–­)' : ''}</div>
            </div>
          </div>
        `
      }
      try {
        const rendered = marked.parse(text)
        return `<div class="prose text-sm t-text-primary">${rendered}</div>`
      } catch {
        return `<div class="text-sm t-text-primary whitespace-pre-wrap">${escapeHtml(text)}</div>`
      }
    }

    if (block.type === 'thinking') {
      const text = block.text || ''
      if (!text.trim()) return ''
      const id = 'think-' + Math.random().toString(36).slice(2)
      const thinkPreview = text.trim().slice(0, 45).replace(/\n/g, ' ')
      return `
        <div class="thinking-block">
          <button onclick="toggleCollapse('${id}')" class="w-full flex items-center gap-2 px-3 py-2 text-xs text-purple-400 hover:text-purple-300 text-left">
            <span class="shrink-0">ğŸ’­ æ€è€ƒè¿‡ç¨‹</span>
            ${thinkPreview ? `<span class="t-text-muted truncate flex-1">${escapeHtml(thinkPreview)}â€¦</span>` : '<span class="flex-1"></span>'}
            <svg id="${id}-chevron" class="collapse-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <div id="${id}" class="hidden px-3 pb-2">
            <div class="text-xs t-text-secondary italic whitespace-pre-wrap">${escapeHtml(text.slice(0, 3000))}${text.length > 3000 ? '\n...(å·²æˆªæ–­)' : ''}</div>
          </div>
        </div>
      `
    }

    if (block.type === 'tool_use') {
      const id = 'tool-' + Math.random().toString(36).slice(2)
      const inputStr = JSON.stringify(block.input, null, 2)
      const preview = getToolPreview(block.name, block.input)
      return `
        <div class="tool-block">
          <button onclick="toggleCollapse('${id}')" class="w-full flex items-center gap-2 px-3 py-2 text-xs text-blue-400 hover:text-blue-300 text-left">
            <span class="shrink-0">ğŸ”§ ${escapeHtml(block.name || 'tool')}</span>
            ${preview ? `<span class="t-text-muted truncate flex-1">${escapeHtml(preview)}</span>` : '<span class="flex-1"></span>'}
            <svg id="${id}-chevron" class="collapse-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <div id="${id}" class="hidden px-3 pb-2">
            <pre class="text-xs t-text-secondary overflow-x-auto whitespace-pre-wrap">${escapeHtml(inputStr.slice(0, 2000))}${inputStr.length > 2000 ? '\n...(å·²æˆªæ–­)' : ''}</pre>
          </div>
        </div>
      `
    }

    if (block.type === 'tool_result') {
      const id = 'result-' + Math.random().toString(36).slice(2)
      const text = block.text || ''
      const resultPreview = text.trim().slice(0, 60).replace(/\n/g, ' ')
      return `
        <div class="tool-block result">
          <button onclick="toggleCollapse('${id}')" class="w-full flex items-center gap-2 px-3 py-2 text-xs text-green-400 hover:text-green-300 text-left">
            <span class="shrink-0">ğŸ“¤ å·¥å…·ç»“æœ</span>
            ${resultPreview ? `<span class="t-text-muted truncate flex-1">${escapeHtml(resultPreview)}</span>` : '<span class="flex-1"></span>'}
            <svg id="${id}-chevron" class="collapse-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <div id="${id}" class="hidden px-3 pb-2">
            <pre class="text-xs t-text-secondary overflow-x-auto whitespace-pre-wrap">${escapeHtml(text.slice(0, 3000))}${text.length > 3000 ? '\n...(å·²æˆªæ–­)' : ''}</pre>
          </div>
        </div>
      `
    }

    return ''
  }

  function getToolPreview(name, input) {
    if (!input) return ''
    if (name === 'Bash' || name === 'bash') return input.command?.slice(0, 60) || ''
    if (name === 'Read' || name === 'Write' || name === 'Edit') return input.file_path?.split('/').slice(-2).join('/') || ''
    if (name === 'Glob') return input.pattern || ''
    if (name === 'Grep') return input.pattern || ''
    if (name === 'WebFetch') return input.url?.slice(0, 60) || ''
    if (name === 'Task') return input.description || ''
    return ''
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
  }

  function toggleCollapse(id) {
    const el = document.getElementById(id)
    const chevron = document.getElementById(id + '-chevron')
    if (el) {
      el.classList.toggle('hidden')
      if (chevron) chevron.classList.toggle('open')
    }
  }
  window.toggleCollapse = toggleCollapse

  function renderChat(data) {
    const { meta, messages } = data
    const header = $('chat-header')
    const content = $('chat-content')

    header.innerHTML = `
      <div class="min-w-0">
        <div class="text-sm font-medium t-text-primary truncate">${escapeHtml(meta.cwd || '')}</div>
        <div class="text-xs t-text-faint mt-0.5 flex gap-3">
          <span>Session: ${escapeHtml(meta.sessionId || '')}</span>
          ${meta.gitBranch ? `<span>Branch: ${escapeHtml(meta.gitBranch)}</span>` : ''}
          ${meta.version ? `<span>v${escapeHtml(meta.version)}</span>` : ''}
        </div>
      </div>
      <div class="text-xs t-text-faint">${messages.length} æ¡æ¶ˆæ¯</div>
    `

    if (messages.length === 0) {
      content.innerHTML = '<div class="text-sm t-text-muted py-8 text-center">æ— æ¶ˆæ¯å†…å®¹</div>'
      return
    }

    const html = messages.map(msg => {
      const isUser = msg.role === 'user'
      const blocksHtml = (msg.blocks || []).map(renderContentBlock).join('')
      if (!blocksHtml.trim()) return ''

      return `
        <div class="rounded-lg px-4 py-3.5 ${isUser ? 'msg-user' : 'msg-assistant'}">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm font-semibold ${isUser ? 'text-blue-400' : 'text-green-400'}">
              ${isUser ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– Claude'}
            </span>
            ${msg.model ? `<span class="text-xs t-text-faint">${escapeHtml(msg.model)}</span>` : ''}
            <span class="text-xs t-text-faint ml-auto">${formatDateTime(msg.timestamp)}</span>
          </div>
          <div class="space-y-2">${blocksHtml}</div>
        </div>
      `
    }).join('')

    content.innerHTML = html || '<div class="text-sm t-text-muted py-8 text-center">æ— å¯æ˜¾ç¤ºçš„æ¶ˆæ¯</div>'

    content.querySelectorAll('pre code').forEach(el => {
      hljs.highlightElement(el)
    })

    content.scrollTop = 0
  }

  // â”€â”€â”€ Render: Search Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSearchResults(results, keyword) {
    const sessionEl = $('session-list')
    const chatEl = $('chat-content')
    const chatHeader = $('chat-header')

    $('session-count').textContent = `(${results.length} ä¸ªåŒ¹é…)`
    chatHeader.innerHTML = `<div class="text-sm t-text-secondary">æœç´¢ç»“æœ: <span class="text-blue-400">${escapeHtml(keyword)}</span></div>`
    chatEl.innerHTML = '<div class="text-sm t-text-muted py-8 text-center">â† ç‚¹å‡»æœç´¢ç»“æœæŸ¥çœ‹è¯¦æƒ…</div>'

    if (results.length === 0) {
      sessionEl.innerHTML = `<div class="px-3 py-4 text-sm t-text-muted">æœªæ‰¾åˆ° "${escapeHtml(keyword)}" çš„ç›¸å…³å†…å®¹</div>`
      return
    }

    sessionEl.innerHTML = results.map(r => {
      const project = state.projects.find(p => p.id === r.projectId)
      const projectName = project ? shortProjectName(project.displayName) : r.projectId
      const snippets = r.matches.map(m => {
        const text = m.snippet.replace(
          new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'),
          match => `<mark class="highlight-match">${escapeHtml(match)}</mark>`
        )
        return `<div class="text-xs t-text-secondary truncate">â€¦${text}â€¦</div>`
      }).join('')

      return `
        <div
          class="session-card px-3 py-2.5 cursor-pointer border-b t-border-faint"
          data-id="${r.sessionId}"
          data-project="${r.projectId}"
          role="button"
          tabindex="0"
          aria-label="${escapeHtml(projectName)} â€” ${r.matchCount} å¤„åŒ¹é…"
        >
          <div class="text-xs text-blue-500 mb-1 truncate">${escapeHtml(projectName)}</div>
          <div class="text-xs t-text-muted mb-1">${r.matchCount} å¤„åŒ¹é… Â· ${timeAgo(r.lastModified)}</div>
          ${snippets}
        </div>
      `
    }).join('')

    sessionEl.querySelectorAll('.session-card').forEach(card => {
      const activate = () => {
        sessionEl.querySelectorAll('.session-card').forEach(c => c.classList.remove('active'))
        card.classList.add('active')
        loadSession(card.dataset.project, card.dataset.id)
      }
      card.addEventListener('click', activate)
      card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate() } })
    })
  }

  // â”€â”€â”€ Load Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadProjects() {
    setStatus('åŠ è½½é¡¹ç›®â€¦')
    try {
      const projects = await api('/api/projects')
      state.projects = projects
      renderProjects(projects)
      setStatus(`${projects.length} ä¸ªé¡¹ç›®`)
    } catch (err) {
      setStatus('åŠ è½½å¤±è´¥: ' + err.message, true)
    }
  }

  async function loadSessions(projectId) {
    const sessionEl = $('session-list')
    sessionEl.innerHTML = '<div class="px-3 py-4 text-sm t-text-muted">åŠ è½½ä¸­â€¦</div>'
    $('chat-content').innerHTML = ''
    $('chat-header').innerHTML = '<div class="text-sm t-text-muted">â† é€‰æ‹© Session</div>'

    setStatus('åŠ è½½ sessionsâ€¦')
    try {
      const sessions = await api(`/api/projects/${encodeURIComponent(projectId)}/sessions`)
      renderSessions(sessions, projectId)
      setStatus(`${sessions.length} ä¸ª sessions`)
    } catch (err) {
      sessionEl.innerHTML = `<div class="px-3 py-4 text-sm text-red-400">${err.message}</div>`
      setStatus('åŠ è½½å¤±è´¥', true)
    }
  }

  async function loadSession(projectId, sessionId) {
    const chatEl = $('chat-content')
    chatEl.innerHTML = '<div class="text-sm t-text-muted py-8 text-center">åŠ è½½ä¸­â€¦</div>'
    state.currentSessionId = sessionId

    setStatus('åŠ è½½ sessionâ€¦')
    try {
      const data = await api(`/api/sessions/${sessionId}?projectId=${encodeURIComponent(projectId)}`)
      renderChat(data)
      setStatus(`${data.messages.length} æ¡æ¶ˆæ¯`)
    } catch (err) {
      chatEl.innerHTML = `<div class="text-sm text-red-400 py-8 text-center">${err.message}</div>`
      setStatus('åŠ è½½å¤±è´¥', true)
    }
  }

  // åˆ é™¤ session å¤„ç†å‡½æ•°
  async function handleDeleteSession(sessionId, projectId) {
    // ç¡®è®¤å¯¹è¯æ¡†
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª session å—ï¼Ÿ\nåˆ é™¤åå¯åœ¨å›æ”¶ç«™ä¸­æ¢å¤ï¼ˆä¿ç•™ 30 å¤©ï¼‰')) {
      return
    }

    setStatus('åˆ é™¤ä¸­â€¦')
    try {
      const res = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}?projectId=${encodeURIComponent(projectId)}`, {
        method: 'DELETE'
      })
      const json = await res.json()

      if (!json.success) {
        throw new Error(json.error || 'åˆ é™¤å¤±è´¥')
      }

      // ä»å½“å‰åˆ—è¡¨ä¸­ç§»é™¤
      const sessionEl = $('session-list')
      const card = sessionEl.querySelector(`.session-card[data-id="${sessionId}"]`)
      if (card) {
        card.remove()
      }

      // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ª sessionï¼Œæ¸…ç©ºèŠå¤©åŒºåŸŸ
      if (state.currentSessionId === sessionId) {
        $('chat-content').innerHTML = ''
        $('chat-header').innerHTML = '<div class="text-sm t-text-muted">â† é€‰æ‹© Session</div>'
        state.currentSessionId = null
      }

      // æ›´æ–°è®¡æ•°
      const count = sessionEl.querySelectorAll('.session-card').length
      $('session-count').textContent = `(${count})`

      // æ›´æ–°å›æ”¶ç«™è§’æ ‡
      updateTrashBadge(1)

      setStatus('å·²ç§»è‡³å›æ”¶ç«™')
    } catch (err) {
      setStatus('åˆ é™¤å¤±è´¥: ' + err.message, true)
      alert('åˆ é™¤å¤±è´¥: ' + err.message)
    }
  }

  // â”€â”€â”€ Trash Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function openTrashModal() {
    $('trash-modal').classList.remove('hidden')
    loadTrash()
  }

  function closeTrashModal() {
    $('trash-modal').classList.add('hidden')
  }

  async function loadTrash() {
    if (state.trashLoading) return
    state.trashLoading = true

    const trashList = $('trash-list')
    trashList.innerHTML = '<div class="text-center t-text-muted py-8">åŠ è½½ä¸­â€¦</div>'

    try {
      const res = await fetch('/api/trash')
      const json = await res.json()

      if (!json.success) {
        throw new Error(json.error || 'åŠ è½½å¤±è´¥')
      }

      state.trashItems = json.data.items
      renderTrashItems(state.trashItems)
      updateTrashBadge(state.trashItems.length, true)
    } catch (err) {
      trashList.innerHTML = `<div class="text-center text-red-400 py-8">åŠ è½½å¤±è´¥: ${err.message}</div>`
    } finally {
      state.trashLoading = false
    }
  }

  function renderTrashItems(items) {
    const trashList = $('trash-list')
    const emptyBtn = $('empty-trash-btn')

    $('trash-count').textContent = items.length

    if (items.length === 0) {
      trashList.innerHTML = '<div class="text-center t-text-muted py-8">å›æ”¶ç«™ä¸ºç©º</div>'
      emptyBtn.disabled = true
      return
    }

    emptyBtn.disabled = false

    trashList.innerHTML = items.map(item => `
      <div class="trash-item p-3" data-id="${item.sessionId}" data-project="${item.projectId}">
        <div class="flex items-start justify-between mb-2">
          <div class="flex-1 min-w-0">
            <div class="text-xs text-blue-500 mb-1 truncate">${shortProjectName(item.projectName)}</div>
            <div class="text-sm t-text-primary truncate">${item.firstUserMessage}</div>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-xs t-text-muted">
            <span>${item.messageCount} æ¡</span>
            <span class="mx-1">Â·</span>
            <span>${timeAgo(item.deletedAt)}</span>
            <span class="mx-1">Â·</span>
            <span class="text-yellow-600">${item.daysRemaining} å¤©åæ¸…ç†</span>
          </div>
          <div class="trash-actions flex gap-2">
            <button class="restore-btn text-xs px-2 py-1 bg-green-600/20 text-green-400 hover:bg-green-600/30 rounded transition-colors"
                    data-id="${item.sessionId}" data-project="${item.projectId}">
              æ¢å¤
            </button>
            <button class="permanent-delete-btn text-xs px-2 py-1 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded transition-colors"
                    data-id="${item.sessionId}" data-project="${item.projectId}">
              åˆ é™¤
            </button>
          </div>
        </div>
      </div>
    `).join('')

    // ç»‘å®šæ¢å¤æŒ‰é’®äº‹ä»¶
    trashList.querySelectorAll('.restore-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        handleRestore(btn.dataset.id, btn.dataset.project)
      })
    })

    // ç»‘å®šæ°¸ä¹…åˆ é™¤æŒ‰é’®äº‹ä»¶
    trashList.querySelectorAll('.permanent-delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        handlePermanentDelete(btn.dataset.id, btn.dataset.project)
      })
    })
  }

  async function handleRestore(sessionId, projectId) {
    if (!confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ª session å—ï¼Ÿ')) return

    setStatus('æ¢å¤ä¸­â€¦')
    try {
      const res = await fetch(`/api/trash/${encodeURIComponent(sessionId)}/restore?projectId=${encodeURIComponent(projectId)}`, {
        method: 'POST'
      })
      const json = await res.json()

      if (!json.success) {
        throw new Error(json.error || 'æ¢å¤å¤±è´¥')
      }

      // ä»åˆ—è¡¨ä¸­ç§»é™¤
      state.trashItems = state.trashItems.filter(item =>
        !(item.sessionId === sessionId && item.projectId === projectId)
      )
      renderTrashItems(state.trashItems)
      updateTrashBadge(state.trashItems.length, true)

      setStatus('å·²æ¢å¤')
    } catch (err) {
      setStatus('æ¢å¤å¤±è´¥: ' + err.message, true)
      alert('æ¢å¤å¤±è´¥: ' + err.message)
    }
  }

  async function handlePermanentDelete(sessionId, projectId) {
    if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ª session å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return

    setStatus('åˆ é™¤ä¸­â€¦')
    try {
      const res = await fetch(`/api/trash/${encodeURIComponent(sessionId)}?projectId=${encodeURIComponent(projectId)}`, {
        method: 'DELETE'
      })
      const json = await res.json()

      if (!json.success) {
        throw new Error(json.error || 'åˆ é™¤å¤±è´¥')
      }

      // ä»åˆ—è¡¨ä¸­ç§»é™¤
      state.trashItems = state.trashItems.filter(item =>
        !(item.sessionId === sessionId && item.projectId === projectId)
      )
      renderTrashItems(state.trashItems)
      updateTrashBadge(state.trashItems.length, true)

      setStatus('å·²æ°¸ä¹…åˆ é™¤')
    } catch (err) {
      setStatus('åˆ é™¤å¤±è´¥: ' + err.message, true)
      alert('åˆ é™¤å¤±è´¥: ' + err.message)
    }
  }

  async function handleEmptyTrash() {
    const count = state.trashItems.length
    if (count === 0) return

    if (!confirm(`ç¡®å®šè¦æ¸…ç©ºå›æ”¶ç«™å—ï¼Ÿ\nå°†æ°¸ä¹…åˆ é™¤ ${count} ä¸ª sessionï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return

    setStatus('æ¸…ç©ºä¸­â€¦')
    try {
      const res = await fetch('/api/trash', {
        method: 'DELETE'
      })
      const json = await res.json()

      if (!json.success) {
        throw new Error(json.error || 'æ¸…ç©ºå¤±è´¥')
      }

      state.trashItems = []
      renderTrashItems(state.trashItems)
      updateTrashBadge(0, true)

      setStatus('å›æ”¶ç«™å·²æ¸…ç©º')
    } catch (err) {
      setStatus('æ¸…ç©ºå¤±è´¥: ' + err.message, true)
      alert('æ¸…ç©ºå¤±è´¥: ' + err.message)
    }
  }

  function updateTrashBadge(count, absolute = false) {
    const badge = $('trash-badge')
    if (absolute) {
      // ç›´æ¥è®¾ç½®æ•°å€¼
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count
        badge.classList.remove('hidden')
      } else {
        badge.classList.add('hidden')
      }
    } else {
      // å¢é‡æ›´æ–°
      const current = parseInt(badge.textContent) || 0
      const newCount = current + count
      if (newCount > 0) {
        badge.textContent = newCount > 99 ? '99+' : newCount
        badge.classList.remove('hidden')
      } else {
        badge.classList.add('hidden')
      }
    }
  }

  // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
  $('trash-modal').addEventListener('click', (e) => {
    if (e.target === $('trash-modal')) {
      closeTrashModal()
    }
  })

  async function doSearch() {
    const keyword = $('search-input').value.trim()
    if (!keyword) return

    const project = $('search-project').value
    const from = $('search-from').value
    const to = $('search-to').value

    state.searchMode = true
    $('clear-search-btn').classList.remove('hidden')

    document.querySelectorAll('.project-item').forEach(i => i.classList.remove('active'))

    const sessionEl = $('session-list')
    sessionEl.innerHTML = '<div class="px-3 py-4 text-sm t-text-muted">æœç´¢ä¸­â€¦</div>'
    setStatus('æœç´¢ä¸­â€¦')

    try {
      let url = `/api/search?q=${encodeURIComponent(keyword)}`
      if (project) url += `&project=${encodeURIComponent(project)}`
      if (from) url += `&from=${from}`
      if (to) url += `&to=${to}`

      const res = await fetch(url)
      const json = await res.json()
      if (!json.success) throw new Error(json.error)

      renderSearchResults(json.data, keyword)
      setStatus(`æ‰¾åˆ° ${json.total} ä¸ªåŒ¹é…`)
    } catch (err) {
      sessionEl.innerHTML = `<div class="px-3 py-4 text-sm text-red-400">${err.message}</div>`
      setStatus('æœç´¢å¤±è´¥', true)
    }
  }

  function clearSearch() {
    $('search-input').value = ''
    $('clear-search-btn').classList.add('hidden')
    state.searchMode = false
    $('session-list').innerHTML = '<div class="px-3 py-4 text-sm t-text-muted">â† é€‰æ‹©é¡¹ç›®</div>'
    $('session-count').textContent = ''
    $('chat-content').innerHTML = ''
    $('chat-header').innerHTML = '<div class="text-sm t-text-muted">â† é€‰æ‹© Session</div>'
  }

  // â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('search-btn').addEventListener('click', doSearch)
  $('clear-search-btn').addEventListener('click', clearSearch)
  $('theme-toggle').addEventListener('click', toggleTheme)
  $('trash-btn').addEventListener('click', openTrashModal)
  $('close-trash-btn').addEventListener('click', closeTrashModal)
  $('close-trash-btn-2').addEventListener('click', closeTrashModal)
  $('empty-trash-btn').addEventListener('click', handleEmptyTrash)

  // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼ˆä»…åœ¨ç”¨æˆ·æœªæ‰‹åŠ¨é€‰æ‹©æ—¶ç”Ÿæ•ˆï¼‰
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'dark' : 'light')
    }
  })

  let searchTimer
  $('search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') doSearch()
  })
  $('search-input').addEventListener('input', () => {
    clearTimeout(searchTimer)
    searchTimer = setTimeout(() => {
      if ($('search-input').value.trim().length >= 2) doSearch()
    }, 500)
  })

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  marked.setOptions({
    breaks: true,
    gfm: true
  })

  // åˆå§‹åŒ–ä¸»é¢˜å›¾æ ‡ï¼ˆä¸ <head> ä¸­çš„ data-theme ä¿æŒåŒæ­¥ï¼‰
  applyTheme(getTheme())

  loadProjects()

  // åŠ è½½å›æ”¶ç«™æ•°é‡
  fetch('/api/trash')
    .then(res => res.json())
    .then(json => {
      if (json.success) {
        updateTrashBadge(json.data.items.length, true)
      }
    })
    .catch(() => {
      // å¿½ç•¥é”™è¯¯
    })
  </script>
</body>
</html>
